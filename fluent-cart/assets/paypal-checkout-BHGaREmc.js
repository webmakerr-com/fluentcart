class S{constructor(a,f,e,n){this.form=a,this.orderHandler=f,this.data=e,this.paymentLoader=n,this.$t=this.translate.bind(this)}translate(a){var e;return(((e=window.fct_paypal_data)==null?void 0:e.translations)||{})[a]||a}init(){var h,_;const a=this,f=this.data,e=(_=(h=this.data)==null?void 0:h.intent)==null?void 0:_.mode;let n=document.querySelector(".fluent-cart-checkout_embed_payment_container_paypal");n.innerHTML="";const t=this.form.querySelector(".fluent_cart_payment_methods");t&&(t.style.display="none");let l=null;e==="payment"?this.onetimePaymentHandler(a,f,l,n):e==="subscription"&&this.subscriptionPaymentHandler(a,f,l,n)}async onetimePaymentHandler(a,f,e,n){const t=this,h=new URLSearchParams(window.location.search).get("mode")||"order";paypal.Buttons({style:{shape:"pill",layout:"vertical",label:"paypal",size:"responsive",disableMaxWidth:!0},createOrder:(o,r)=>{var s,p,u,m,y;return(s=t.paymentLoader)==null||s.changeLoaderStatus("processing"),r.order.create({purchase_units:[e.response],application_context:{shipping_preference:"NO_SHIPPING"},intent:"CAPTURE",reference_id:(u=(p=e==null?void 0:e.data)==null?void 0:p.order)!=null&&u.uuid?(y=(m=e==null?void 0:e.data)==null?void 0:m.order)==null?void 0:y.uuid:t.$t("uuid not found")})},onApprove:(o,r)=>{var s;return(s=t.paymentLoader)==null||s.changeLoaderStatus("confirming"),r.order.capture().then(p=>{var u,m,y;if(p.id){(u=t.paymentLoader)==null||u.changeLoaderStatus("completed");const w=new URLSearchParams({action:"fluent_cart_confirm_paypal_payment",payId:p.id,ref_id:(m=e==null?void 0:e.data)!=null&&m.transaction.uuid?(y=e==null?void 0:e.data)==null?void 0:y.transaction.uuid:t.$t("uuid not found"),mode:h}),c=new XMLHttpRequest;c.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.onload=function(){var g;if(c.status>=200&&c.status<300)try{const i=JSON.parse(c.responseText);i!=null&&i.redirect_url&&(t.paymentLoader.triggerPaymentCompleteEvent(i),(g=t.paymentLoader)==null||g.changeLoaderStatus("redirecting"),window.location.href=i.redirect_url)}catch(i){console.error("An error occurred while parsing the response:",i==null?void 0:i.message)}else console.error("Network response was not ok")},c.onerror=function(){try{const g=JSON.parse(c.responseText)}catch(g){console.error("An error occurred:",g)}},c.send(w.toString())}})},onCancel:o=>{var r,s;(r=t.paymentLoader)==null||r.changeLoaderStatus("canceled"),(s=t.paymentLoader)==null||s.hideLoader(),t.paymentLoader.enableCheckoutButton()},onShippingChange:(o,r)=>r.resolve(),onError:o=>{t.handlePaypalError(o,e)},onClick:async function(o,r){var s,p,u,m;if(typeof a.orderHandler=="function"){let y=await a.orderHandler();if(!y)return(s=t.paymentLoader)==null||s.changeLoaderStatus(t.$t("Order creation failed")),(p=t.paymentLoader)==null||p.hideLoader(),r.reject();e=y}else return(u=t.paymentLoader)==null||u.changeLoaderStatus(t.$t("Not proper order handler")),(m=t.paymentLoader)==null||m.hideLoader(),r.reject()}}).render(n).then(()=>{window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_success",{detail:{payment_method:"paypal"}}));const o=document.getElementById("fct_loading_payment_processor");o&&o.remove()});const d=document.createElement("p");d.id="fct-extra-checkout-text-for-paypal",d.style.textAlign="center",d.style.marginTop="10px",d.style.fontSize="14px",d.style.color="#666",d.textContent=t.$t("Choose any option to continue"),n.appendChild(d)}async subscriptionPaymentHandler(a,f,e,n){const t=this,h=new URLSearchParams(window.location.search).get("mode")||"order";paypal.Buttons({style:{shape:"pill",layout:"vertical",label:"paypal",size:"responsive",disableMaxWidth:!0},createSubscription:function(o,r){return r.subscription.create({plan_id:e.response.planId,custom_id:e.data.subscription.uuid})},onApprove:function(o,r){var s,p,u,m,y;if((s=t.paymentLoader)==null||s.changeLoaderStatus("confirming"),o.subscriptionID){console.log(e,o),(p=t.paymentLoader)==null||p.changeLoaderStatus("completed");const w=new URLSearchParams({action:"fluent_cart_confirm_paypal_subscription",order_id:o.orderID,subscription_id:o.subscriptionID,ref_id:(u=e==null?void 0:e.data)==null?void 0:u.transaction.uuid,mode:h}),c=new XMLHttpRequest;c.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.onload=function(){var g;if(c.status>=200&&c.status<300)try{const i=JSON.parse(c.responseText);i!=null&&i.redirect_url&&(t.paymentLoader.triggerPaymentCompleteEvent(i),(g=t.paymentLoader)==null||g.changeLoaderStatus("redirecting"),window.location.href=i.redirect_url)}catch(i){console.error("An error occurred while parsing the response:",i)}else console.error("Network response was not ok")},c.send(w.toString())}else(m=t.paymentLoader)==null||m.changeLoaderStatus(t.$t("No Subscription ID")),(y=t.paymentLoader)==null||y.hideLoader()},onCancel:o=>{var r,s;(r=t.paymentLoader)==null||r.changeLoaderStatus("canceled"),(s=t.paymentLoader)==null||s.hideLoader(),t.paymentLoader.enableCheckoutButton()},onShippingChange(o,r){return r.resolve()},onClick:async function(o,r){var s,p,u,m,y;if((s=t.paymentLoader)==null||s.changeLoaderStatus(t.$t("no processing")),typeof a.orderHandler=="function"){let w=await a.orderHandler();if(!w)return(p=t.paymentLoader)==null||p.changeLoaderStatus(t.$t("Order creation failed")),(u=t.paymentLoader)==null||u.hideLoader(),r.reject();e=w}else return(m=t.paymentLoader)==null||m.changeLoaderStatus(t.$t("not proper order handler")),(y=t.paymentLoader)==null||y.hideLoader(),r.reject()},onError:function(o){t.handlePaypalError(o,e)}}).render(n).then(()=>{window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_success",{detail:{payment_method:"paypal"}}));const o=document.getElementById("fct_loading_payment_processor");o&&o.remove()});const d=document.createElement("p");d.id="fct-extra-checkout-text-for-paypal",d.style.textAlign="center",d.style.marginTop="10px",d.style.fontSize="14px",d.style.color="#666",d.textContent=t.$t("Choose any option to continue"),n.appendChild(d)}handlePaypalError(a,f){var n,t;let e=this.$t("An unknown error occurred");if(a!=null&&a.message)try{const l=a.message.match(/{.*}/s);l?e=JSON.parse(l[0]).message||e:e=a.message}catch{e=a.message||e}(n=this.paymentLoader)==null||n.changeLoaderStatus(a),(t=this.paymentLoader)==null||t.hideLoader(),this.paymentLoader.enableCheckoutButton()}}window.addEventListener("fluent_cart_load_payments_paypal",function(L){window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading",{detail:{payment_method:"paypal"}})),window.fluentcart.$t,f(),fetch(L.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":L.detail.nonce},credentials:"include"}).then(async e=>{e=await e.json(),(e==null?void 0:e.status)==="failed"&&a(e==null?void 0:e.message),new S(L.detail.form,L.detail.orderHandler,e,L.detail.paymentLoader).init()}).catch(e=>{var h;const n=((h=window.fct_paypal_data)==null?void 0:h.translations)||{};function t(_){return n[_]||_}let l=(e==null?void 0:e.message)||t("An error occurred while loading PayPal.");a(l)});function a(e){const n=document.createElement("div");n.style.color="red",n.className="fct-error-message",n.textContent=e,document.querySelector(".fluent-cart-checkout_embed_payment_container_paypal").appendChild(n);const l=document.getElementById("fct_loading_payment_processor");l&&l.remove()}function f(){var h;let e=document.querySelector(".fluent-cart-checkout_embed_payment_container_paypal");const n=document.createElement("p");n.id="fct_loading_payment_processor";const t=((h=window.fct_paypal_data)==null?void 0:h.translations)||{};function l(_){return t[_]||_}n.textContent=l("Loading Payment Processor..."),e.appendChild(n)}});
