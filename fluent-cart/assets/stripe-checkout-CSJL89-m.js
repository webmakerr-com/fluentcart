const ue=()=>new Promise((l,u)=>{if(window.Stripe)return l(window.Stripe);const f=document.createElement("script");f.src="https://js.stripe.com/v3/",f.async=!0,f.onload=()=>{window.Stripe?l(window.Stripe):u(new Error("Stripe.js failed to load"))},f.onerror=()=>u(new Error("Stripe.js failed to load")),document.head.appendChild(f)});class V{constructor(l,u,f){this.form=l,this.data=u,this.paymentArgs=u.payment_args,this.intent=u.intent,this.paymentLoader=f,this.$t=this.translate.bind(this)}translate(l){var f;return(((f=window.fct_stripe_data)==null?void 0:f.translations)||{})[l]||l}async init(){var x,L;const l=document.querySelector("[data-fluent-cart-checkout-page-checkout-button]"),u=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe"),f=this.form.querySelector(".fluent_cart_payment_methods");f&&(f.style.display="none");const o=this,t=(x=this.paymentArgs)==null?void 0:x.public_key;if(!t){this.showError(u,this.$t("Payment module not available to checkout! Please reload again, or contact admin!"));const i=document.getElementById("fct_loading_payment_processor");return i&&i.remove(),void(this.paymentLoader&&this.paymentLoader.disableCheckoutButton((L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button.text))}let E;try{E=await ue()}catch(i){return this.showError(u,this.$t("Error loading Stripe. Please try again.")),void(this.paymentLoader&&this.paymentLoader.disableCheckoutButton((L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button.text))}const i=E(t),p=(this.intent==null?void 0:this.intent.client_secret)||(this.intent==null?void 0:this.intent.clientSecret)||this.intent;if(!p){const a=document.createElement("div");a.className="fct-error-message",a.textContent=this.$t("Payment module not available to checkout! Please reload again, or contact admin!"),u.appendChild(a);const s=document.getElementById("fct_loading_payment_processor");return s&&s.remove(),void(this.paymentLoader&&this.paymentLoader.disableCheckoutButton((L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button.text))}const i=await t.elements({clientSecret:E}),p={fields:{billingDetails:{name:"never",email:"never"}}},d=await i.create("payment",p);d.mount(".fluent-cart-checkout_embed_payment_container_stripe");const r=(L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button;d.on("loaderror",function(a){var g,e,k;window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_failed",{detail:{payment_method:"stripe"}}));const _=document.getElementById("fct_loading_payment_processor");_&&_.remove();let s=(g=a==null?void 0:a.error)==null?void 0:g.message,m="";if(((e=window==null?void 0:window.fluentcart_checkout_info)==null?void 0:e.is_admin)!=="1"){s=o.$t("Payment module not available to checkout! Please reload again, or contact admin!"),m=`<p style="color:red; display:none;" class="hidden-error">${(k=a==null?void 0:a.error)==null?void 0:k.message}</p>`;const w=document.createElement("a");w.className="toggle-error",w.style.cursor="pointer",w.textContent=o.$t("See Errors"),w.addEventListener("click",function(){document.querySelector(".hidden-error").style.display=document.querySelector(".hidden-error").style.display==="none"?"block":"none"}),u.prepend(w)}const n=document.createElement("p");n.style.color="red",n.innerHTML=s+m,u.prepend(n),window.is_stripe_ready=!1,o.paymentLoader.disableCheckoutButton(r==null?void 0:r.text)}),d.on("ready",function(a){window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_success",{detail:{payment_method:"stripe"}}));const _=document.getElementById("fct_loading_payment_processor");if(_&&_.remove(),l&&l.id==="fluent_cart_custom_checkout_btn")o.paymentLoader.disableCheckoutButton(o.$t("Pay Now"));else{const s=o.form.querySelector('input[name="_fct_pay_method"]:checked');s&&s.value==="stripe"&&o.paymentLoader.disableCheckoutButton(r.text)}window.is_stripe_ready=!1,d.addEventListener("change",function(s){window.is_stripe_ready=s.complete,document.querySelectorAll(".fct-error-message").forEach(n=>n.remove()),window.is_stripe_ready?l&&l.id==="fluent_cart_custom_checkout_btn"?o.paymentLoader.enableCheckoutButton(o.$t("Pay Now")):o.paymentLoader.enableCheckoutButton(r.text):o.paymentLoader.disableCheckoutButton(r!=null&&r.text?r.text:o.$t("Place Order"))}),window.addEventListener("fluent_cart_payment_next_action_stripe",s=>{var M,T,$,I,N,B,A,O,U,j,C;(M=o.paymentLoader)==null||M.changeLoaderStatus("processing");const m=document.querySelector(".fct-loader");(T=m==null?void 0:m.classList)==null||T.add("active");const n=($=s.detail)==null?void 0:$.response;let g=(I=n==null?void 0:n.payment_args)==null?void 0:I.success_url;(N=n==null?void 0:n.payment_args)==null||N.custom_payment_url;const e=n==null?void 0:n.fc_customer;let k=null,w="intent";((B=n==null?void 0:n.response)==null?void 0:B.object)==="subscription"?(w=(O=(A=n==null?void 0:n.payment_args)==null?void 0:A.vendor_subscription_info)==null?void 0:O.type,k=(j=(U=n==null?void 0:n.payment_args)==null?void 0:U.vendor_subscription_info)==null?void 0:j.clientSecret):k=(C=n==null?void 0:n.response)==null?void 0:C.client_secret;const z=function(q){new Toastify({text:q,className:"warning",duration:2e3,escapeMarkup:!1,close:!0}).showToast()};i.submit().then(q=>{const v=w==="setup"?t.confirmSetup:t.confirmPayment,E=w==="setup"?"setupIntent":"paymentIntent",F={elements:i,clientSecret:k,confirmParams:{return_url:g,payment_method_data:{billing_details:{address:{city:e!=null&&e.city?e==null?void 0:e.city:null,country:e!=null&&e.country?e==null?void 0:e.country:null,postal_code:e!=null&&e.postcode?e==null?void 0:e.postcode:null,state:e!=null&&e.state?e==null?void 0:e.state:null,line1:e!=null&&e.address_1?e==null?void 0:e.address_1:null},name:e==null?void 0:e.name,email:e==null?void 0:e.email}}},redirect:"if_required"};v(F).then(y=>{var D,H,Q,J,X;(D=o.paymentLoader)==null||D.changeLoaderStatus("confirming"),y!=null&&y.error&&(console.log("inside error",(H=y==null?void 0:y.error)==null?void 0:H.message),o.paymentLoader.enableCheckoutButton(r.text),z((Q=y==null?void 0:y.error)==null?void 0:Q.message),(J=o.paymentLoader)==null||J.hideLoader());const c=y[E];if(c!=null&&c.status&&(c.status==="succeeded"||c.status==="processing"||c.status==="requires_capture")){(X=o.paymentLoader)==null||X.changeLoaderStatus("completed");const G=new URLSearchParams(window.location.search).get("mode")||"order",K=new URLSearchParams({action:"fluent_cart_confirm_stripe_payment",intentId:c.id,mode:G}).toString(),h=new XMLHttpRequest;h.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),h.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.onreadystatechange=function(){var W;if(h.readyState===4)if(h.status>=200&&h.status<300){(W=o.paymentLoader)==null||W.changeLoaderStatus("redirecting");let S=JSON.parse(h.responseText);S&&(o.paymentLoader.triggerPaymentCompleteEvent(S),S.redirect_url&&(g=S.redirect_url)),window.location.href=g}else console.log(h.responseText,"failed")},h.onerror=function(){console.log("Request failed")},h.send(K)}else if((c==null?void 0:c.status)==="requires_action"||(c==null?void 0:c.status)==="requires_source_action")return P(c)})}).catch(q=>{var v,E;console.log(q,"failed"),m.classList.remove("active"),(v=o.paymentLoader)==null||v.changeLoaderStatus("failed"),(E=o.paymentLoader)==null||E.hideLoader()})})});const P=a=>{var s,m;(s=o.paymentLoader)==null||s.changeLoaderStatus(o.$t("redirecting for action"));const _=(m=a.next_action)==null?void 0:m.type;switch(_){case"redirect_to_url":window.location.href=a.next_action.redirect_to_url.url;break;case"cashapp_handle_redirect_or_display_qr_code":a.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url?window.location.href=a.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url:console.log("QR Code:",a.next_action.cashapp_handle_redirect_or_display_qr_code.qr_code);break;case"display_boleto":window.location.href=a.next_action.boleto_display_details.hosted_voucher_url;break;case"oxxo_display_details":window.location.href=a.next_action.oxxo_display_details.hosted_voucher_url;break;case"alipay_handle_redirect":window.location.href=a.next_action.alipay_handle_redirect.url;break;case"konbini_display_details":window.location.href=a.next_action.konbini_display_details.hosted_voucher_url;break;case"display_bank_transfer_instructions":window.location.href=a.next_action.display_bank_transfer_instructions.hosted_instructions_url;break;case"verify_with_microdeposits":window.location.href=a.next_action.verify_with_microdeposits.hosted_verification_url;break;case"wechat_pay_display_qr_code":a.next_action.wechat_pay_display_qr_code.hosted_instructions_url?window.location.href=a.next_action.wechat_pay_display_qr_code.hosted_instructions_url:console.log("QR Code:",a.next_action.wechat_pay_display_qr_code.qr_code);break;case"promptpay_display_qr_code":a.next_action.promptpay_display_qr_code.hosted_instructions_url?window.location.href=a.next_action.promptpay_display_qr_code.hosted_instructions_url:console.log("QR Code:",a.next_action.promptpay_display_qr_code.qr_code);break;default:console.error("Unsupported next_action type:",_);break}};showError(l,u){const f=document.createElement("div");f.className="fct-error-message",f.textContent=u,l.appendChild(f)}window.addEventListener("fluent_cart_validate_checkout_stripe",function(a){if(!window.is_stripe_ready){const _=document.createElement("div");_.className="fct-error-message",_.textContent=o.$t("Card details are not valid!"),document.querySelector(".fluent-cart-checkout-page-checkout-form-order-summary").appendChild(_),t.confirmPayment({elements:i,confirmParams:{return_url:"https://stripe.com"},redirect:"if_required"})}})}}window.addEventListener("fluent_cart_load_payments_stripe",function(b){window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading",{detail:{payment_method:"stripe"}})),window.fluentcart.$t;const l=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe");o(),f(),fetch(b.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":b.detail.nonce},credentials:"include"}).then(async t=>{var p,d,r;if(t=await t.json(),(t==null?void 0:t.status)==="failed"&&u(t==null?void 0:t.message),((p=t==null?void 0:t.intent)==null?void 0:p.amount)<=0&&((d=t==null?void 0:t.intent)==null?void 0:d.mode)!=="subscription"){let x=function(a){return P[a]||a};var i=x;const P=((r=window.fct_stripe_data)==null?void 0:r.translations)||{};u(x("Total amount is not valid, please add some items to cart!"));const L=document.getElementById("fct_loading_payment_processor");L&&L.remove();return}new V(b.detail.form,t,b.detail.paymentLoader).init()}).catch(t=>{var d;const i=((d=window.fct_stripe_data)==null?void 0:d.translations)||{};function p(r){return i[r]||r}u(p("An error occurred while parsing the response."))});function u(t){if(!t)return;const i=document.createElement("div");i.className="fct-error-message",i.textContent=t,l.appendChild(i);const p=document.getElementById("fct_loading_payment_processor");p&&p.remove()}function f(){var d;const t=document.createElement("p");t.id="fct_loading_payment_processor";const i=((d=window.fct_stripe_data)==null?void 0:d.translations)||{};function p(r){return i[r]||r}t.textContent=p("Loading Payment Processor..."),l.appendChild(t)}function o(){document.querySelectorAll(".fct-error-message").forEach(i=>i.remove())}});
